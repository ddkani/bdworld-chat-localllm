# ğŸ’¬ ì‹¤ì‹œê°„ ì±„íŒ… êµ¬í˜„ ì´í•´í•˜ê¸°

## ğŸ“Œ WebSocketì´ë€?

**WebSocket**ì€ ì‹¤ì‹œê°„ ì–‘ë°©í–¥ í†µì‹ ì„ ìœ„í•œ í”„ë¡œí† ì½œì…ë‹ˆë‹¤.
- HTTPì™€ ë‹¬ë¦¬ **ì—°ê²°ì„ ìœ ì§€**í•˜ë©° í†µì‹ 
- ì „í™” í†µí™”ì²˜ëŸ¼ **ì‹¤ì‹œê°„ ëŒ€í™”** ê°€ëŠ¥
- ì±„íŒ…, ê²Œì„, ì‹¤ì‹œê°„ ì•Œë¦¼ì— ì‚¬ìš©

### HTTP vs WebSocket
```
[HTTP - í¸ì§€]
í´ë¼ì´ì–¸íŠ¸: "ë°ì´í„° ì£¼ì„¸ìš”" â†’
                            â† ì„œë²„: "ì—¬ê¸° ìˆìŠµë‹ˆë‹¤"
(ì—°ê²° ì¢…ë£Œ)

[WebSocket - ì „í™”]
í´ë¼ì´ì–¸íŠ¸ â†â†’ ì„œë²„
(ì—°ê²° ìœ ì§€, ì‹¤ì‹œê°„ ëŒ€í™”)
```

## ğŸ”Œ WebSocket ì—°ê²° ê³¼ì •

```
1. í•¸ë“œì…°ì´í¬ (ì•…ìˆ˜)
   í´ë¼ì´ì–¸íŠ¸ â†’ ì„œë²„: "WebSocketìœ¼ë¡œ ì—°ê²°í•˜ê³  ì‹¶ì–´ìš”"
   
2. ì—…ê·¸ë ˆì´ë“œ
   ì„œë²„ â†’ í´ë¼ì´ì–¸íŠ¸: "ì¢‹ì•„ìš”, WebSocketìœ¼ë¡œ ì „í™˜í• ê²Œìš”"
   
3. ì—°ê²° ìœ ì§€
   ì–‘ë°©í–¥ ì‹¤ì‹œê°„ í†µì‹  ì‹œì‘
   
4. ì—°ê²° ì¢…ë£Œ
   ì–´ëŠ í•œìª½ì´ ì—°ê²°ì„ ëŠì„ ë•Œê¹Œì§€ ìœ ì§€
```

## ğŸ–¥ï¸ ë°±ì—”ë“œ êµ¬í˜„ (Django Channels)

### 1. Django Channels ì„¤ì •
```python
# settings.py
INSTALLED_APPS = [
    'daphne',  # ASGI ì„œë²„
    'channels',  # WebSocket ì§€ì›
    # ...
]

# ASGI ì„¤ì •
ASGI_APPLICATION = 'chat_project.asgi.application'

# ì±„ë„ ë ˆì´ì–´ ì„¤ì • (ë©”ì‹œì§€ ë¸Œë¡œì»¤)
CHANNEL_LAYERS = {
    'default': {
        'BACKEND': 'channels_redis.core.RedisChannelLayer',
        'CONFIG': {
            "hosts": [('127.0.0.1', 6379)],
        },
    },
}
```

### 2. ASGI ì„¤ì •
```python
# asgi.py
import os
from django.core.asgi import get_asgi_application
from channels.routing import ProtocolTypeRouter, URLRouter
from channels.auth import AuthMiddlewareStack
import chat.routing

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 
                     'chat_project.settings')

application = ProtocolTypeRouter({
    "http": get_asgi_application(),
    "websocket": AuthMiddlewareStack(
        URLRouter(
            chat.routing.websocket_urlpatterns
        )
    ),
})
```

### 3. WebSocket ë¼ìš°íŒ…
```python
# chat/routing.py
from django.urls import re_path
from . import consumers

websocket_urlpatterns = [
    re_path(
        r'ws/chat/(?P<session_id>\w+)/$', 
        consumers.ChatConsumer.as_asgi()
    ),
]
```

### 4. Consumer (WebSocket í•¸ë“¤ëŸ¬)
```python
# chat/consumers.py
import json
from channels.generic.websocket import AsyncWebsocketConsumer
from channels.db import database_sync_to_async
from .models import ChatSession, Message
from llm.llm_service import LLMService

class ChatConsumer(AsyncWebsocketConsumer):
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        self.llm_service = LLMService()
    
    async def connect(self):
        """WebSocket ì—°ê²° ì‹œì‘"""
        self.session_id = self.scope['url_route']['kwargs']['session_id']
        self.room_group_name = f'chat_{self.session_id}'
        
        # ë£¸ ê·¸ë£¹ì— ì°¸ê°€
        await self.channel_layer.group_add(
            self.room_group_name,
            self.channel_name
        )
        
        await self.accept()
        
        # í™˜ì˜ ë©”ì‹œì§€
        await self.send(text_data=json.dumps({
            'type': 'connection',
            'message': 'ì±„íŒ…ì— ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.'
        }))
    
    async def disconnect(self, close_code):
        """WebSocket ì—°ê²° ì¢…ë£Œ"""
        await self.channel_layer.group_discard(
            self.room_group_name,
            self.channel_name
        )
    
    async def receive(self, text_data):
        """ë©”ì‹œì§€ ìˆ˜ì‹  ë° ì²˜ë¦¬"""
        data = json.loads(text_data)
        message = data['message']
        
        # ì‚¬ìš©ì ë©”ì‹œì§€ ì €ì¥
        await self.save_message(message, is_user=True)
        
        # ì‚¬ìš©ì ë©”ì‹œì§€ ë¸Œë¡œë“œìºìŠ¤íŠ¸
        await self.channel_layer.group_send(
            self.room_group_name,
            {
                'type': 'chat_message',
                'message': message,
                'is_user': True
            }
        )
        
        # AI ì‘ë‹µ ìƒì„± (ìŠ¤íŠ¸ë¦¬ë°)
        ai_response = ""
        async for chunk in self.llm_service.generate_stream(message):
            ai_response += chunk
            
            # ê° ì²­í¬ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ì „ì†¡
            await self.send(text_data=json.dumps({
                'type': 'ai_chunk',
                'chunk': chunk
            }))
        
        # ì™„ì„±ëœ AI ì‘ë‹µ ì €ì¥
        await self.save_message(ai_response, is_user=False)
        
        # AI ì‘ë‹µ ì™„ë£Œ ì‹ í˜¸
        await self.send(text_data=json.dumps({
            'type': 'ai_complete',
            'message': ai_response
        }))
    
    async def chat_message(self, event):
        """ê·¸ë£¹ ë©”ì‹œì§€ ì „ë‹¬"""
        await self.send(text_data=json.dumps({
            'type': 'message',
            'message': event['message'],
            'is_user': event['is_user']
        }))
    
    @database_sync_to_async
    def save_message(self, content, is_user):
        """ë©”ì‹œì§€ ë°ì´í„°ë² ì´ìŠ¤ ì €ì¥"""
        session = ChatSession.objects.get(id=self.session_id)
        Message.objects.create(
            session=session,
            content=content,
            is_user=is_user
        )
```

## ğŸ’» í”„ë¡ íŠ¸ì—”ë“œ êµ¬í˜„

### 1. WebSocket ì„œë¹„ìŠ¤
```typescript
// services/websocket.ts
export class WebSocketService {
  private socket: WebSocket | null = null;
  private messageHandlers: ((data: any) => void)[] = [];
  
  connect(sessionId: string): Promise<void> {
    return new Promise((resolve, reject) => {
      this.socket = new WebSocket(
        `ws://localhost:8000/ws/chat/${sessionId}/`
      );
      
      this.socket.onopen = () => {
        console.log('WebSocket ì—°ê²° ì„±ê³µ');
        resolve();
      };
      
      this.socket.onerror = (error) => {
        console.error('WebSocket ì—ëŸ¬:', error);
        reject(error);
      };
      
      this.socket.onmessage = (event) => {
        const data = JSON.parse(event.data);
        this.handleMessage(data);
      };
      
      this.socket.onclose = () => {
        console.log('WebSocket ì—°ê²° ì¢…ë£Œ');
        this.reconnect(sessionId);
      };
    });
  }
  
  private handleMessage(data: any) {
    // ë©”ì‹œì§€ íƒ€ì…ë³„ ì²˜ë¦¬
    switch(data.type) {
      case 'connection':
        console.log('ì—°ê²°ë¨:', data.message);
        break;
        
      case 'ai_chunk':
        // AI ì‘ë‹µ ìŠ¤íŠ¸ë¦¬ë°
        this.messageHandlers.forEach(handler => 
          handler({
            type: 'chunk',
            content: data.chunk
          })
        );
        break;
        
      case 'ai_complete':
        // AI ì‘ë‹µ ì™„ë£Œ
        this.messageHandlers.forEach(handler => 
          handler({
            type: 'complete',
            content: data.message
          })
        );
        break;
        
      case 'message':
        // ì¼ë°˜ ë©”ì‹œì§€
        this.messageHandlers.forEach(handler => 
          handler({
            type: 'message',
            content: data.message,
            isUser: data.is_user
          })
        );
        break;
    }
  }
  
  sendMessage(message: string) {
    if (this.socket?.readyState === WebSocket.OPEN) {
      this.socket.send(JSON.stringify({ 
        message 
      }));
    }
  }
  
  onMessage(handler: (data: any) => void) {
    this.messageHandlers.push(handler);
  }
  
  private reconnect(sessionId: string) {
    console.log('ì¬ì—°ê²° ì‹œë„...');
    setTimeout(() => {
      this.connect(sessionId);
    }, 3000);
  }
  
  disconnect() {
    if (this.socket) {
      this.socket.close();
      this.socket = null;
    }
  }
}
```

### 2. React ì»´í¬ë„ŒíŠ¸ì—ì„œ ì‚¬ìš©
```typescript
// components/ChatInterface.tsx
import React, { useState, useEffect, useRef } from 'react';
import { WebSocketService } from '../services/websocket';

const ChatInterface: React.FC = () => {
  const [messages, setMessages] = useState<Message[]>([]);
  const [input, setInput] = useState('');
  const [currentAIMessage, setCurrentAIMessage] = useState('');
  const [isConnected, setIsConnected] = useState(false);
  const wsService = useRef(new WebSocketService());
  
  useEffect(() => {
    // WebSocket ì—°ê²°
    const connectWebSocket = async () => {
      try {
        await wsService.current.connect(sessionId);
        setIsConnected(true);
        
        // ë©”ì‹œì§€ í•¸ë“¤ëŸ¬ ë“±ë¡
        wsService.current.onMessage((data) => {
          if (data.type === 'chunk') {
            // AI ì‘ë‹µ ìŠ¤íŠ¸ë¦¬ë° ì—…ë°ì´íŠ¸
            setCurrentAIMessage(prev => prev + data.content);
          } else if (data.type === 'complete') {
            // AI ì‘ë‹µ ì™„ë£Œ
            setMessages(prev => [...prev, {
              content: data.content,
              isUser: false,
              timestamp: new Date()
            }]);
            setCurrentAIMessage('');
          } else if (data.type === 'message') {
            // ì¼ë°˜ ë©”ì‹œì§€
            setMessages(prev => [...prev, {
              content: data.content,
              isUser: data.isUser,
              timestamp: new Date()
            }]);
          }
        });
      } catch (error) {
        console.error('ì—°ê²° ì‹¤íŒ¨:', error);
        setIsConnected(false);
      }
    };
    
    connectWebSocket();
    
    // ì»´í¬ë„ŒíŠ¸ ì–¸ë§ˆìš´íŠ¸ ì‹œ ì—°ê²° ì¢…ë£Œ
    return () => {
      wsService.current.disconnect();
    };
  }, [sessionId]);
  
  const sendMessage = () => {
    if (!input.trim() || !isConnected) return;
    
    // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
    setMessages(prev => [...prev, {
      content: input,
      isUser: true,
      timestamp: new Date()
    }]);
    
    // WebSocketìœ¼ë¡œ ì „ì†¡
    wsService.current.sendMessage(input);
    
    // ì…ë ¥ì°½ ì´ˆê¸°í™”
    setInput('');
  };
  
  return (
    <div className="chat-container">
      <div className="connection-status">
        {isConnected ? 'ğŸŸ¢ ì—°ê²°ë¨' : 'ğŸ”´ ì—°ê²° ì•ˆë¨'}
      </div>
      
      <div className="messages">
        {messages.map((msg, idx) => (
          <div 
            key={idx} 
            className={`message ${msg.isUser ? 'user' : 'ai'}`}
          >
            <div className="avatar">
              {msg.isUser ? 'ğŸ‘¤' : 'ğŸ¤–'}
            </div>
            <div className="content">
              {msg.content}
            </div>
          </div>
        ))}
        
        {/* AI ì‘ë‹µ ìŠ¤íŠ¸ë¦¬ë° í‘œì‹œ */}
        {currentAIMessage && (
          <div className="message ai streaming">
            <div className="avatar">ğŸ¤–</div>
            <div className="content">
              {currentAIMessage}
              <span className="cursor">â–Š</span>
            </div>
          </div>
        )}
      </div>
      
      <div className="input-area">
        <input
          type="text"
          value={input}
          onChange={(e) => setInput(e.target.value)}
          onKeyPress={(e) => e.key === 'Enter' && sendMessage()}
          placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
          disabled={!isConnected}
        />
        <button 
          onClick={sendMessage}
          disabled={!isConnected}
        >
          ì „ì†¡
        </button>
      </div>
    </div>
  );
};
```

### 3. ìŠ¤íƒ€ì¼ë§
```css
/* ChatInterface.css */
.chat-container {
  display: flex;
  flex-direction: column;
  height: 100vh;
}

.connection-status {
  padding: 10px;
  background: #f0f0f0;
  text-align: center;
}

.messages {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
}

.message {
  display: flex;
  margin-bottom: 15px;
  animation: slideIn 0.3s ease;
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.message.user {
  flex-direction: row-reverse;
}

.message .avatar {
  font-size: 24px;
  margin: 0 10px;
}

.message .content {
  max-width: 70%;
  padding: 10px 15px;
  border-radius: 15px;
  background: #e0e0e0;
}

.message.user .content {
  background: #007bff;
  color: white;
}

.message.ai.streaming .cursor {
  animation: blink 1s infinite;
}

@keyframes blink {
  0%, 50% { opacity: 1; }
  51%, 100% { opacity: 0; }
}

.input-area {
  display: flex;
  padding: 20px;
  border-top: 1px solid #ddd;
}

.input-area input {
  flex: 1;
  padding: 10px;
  border: 1px solid #ddd;
  border-radius: 20px;
  margin-right: 10px;
}

.input-area button {
  padding: 10px 20px;
  background: #007bff;
  color: white;
  border: none;
  border-radius: 20px;
  cursor: pointer;
}

.input-area button:disabled {
  background: #ccc;
  cursor: not-allowed;
}
```

## ğŸ”„ ì‹¤ì‹œê°„ í†µì‹  íë¦„

```
1. ì‚¬ìš©ìê°€ ë©”ì‹œì§€ ì…ë ¥
        â†“
2. WebSocketìœ¼ë¡œ ì„œë²„ ì „ì†¡
        â†“
3. Django Consumer ìˆ˜ì‹ 
        â†“
4. ë©”ì‹œì§€ DB ì €ì¥
        â†“
5. AI ëª¨ë¸ì— ì „ë‹¬
        â†“
6. AI ì‘ë‹µ ìŠ¤íŠ¸ë¦¬ë°
        â†“
7. ê° ì²­í¬ë¥¼ WebSocketìœ¼ë¡œ ì „ì†¡
        â†“
8. í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ì‹¤ì‹œê°„ í‘œì‹œ
        â†“
9. ì™„ë£Œ í›„ ì „ì²´ ì‘ë‹µ ì €ì¥
```

## ğŸš€ ê³ ê¸‰ ê¸°ëŠ¥

### 1. íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„°
```typescript
// ìƒëŒ€ë°©ì´ íƒ€ì´í•‘ ì¤‘ì„ì„ í‘œì‹œ
const [isTyping, setIsTyping] = useState(false);

const handleTyping = () => {
  wsService.current.send({
    type: 'typing',
    isTyping: true
  });
  
  // 3ì´ˆ í›„ íƒ€ì´í•‘ ì¤‘ì§€
  setTimeout(() => {
    wsService.current.send({
      type: 'typing',
      isTyping: false
    });
  }, 3000);
};
```

### 2. ì˜¨ë¼ì¸ ìƒíƒœ í‘œì‹œ
```python
# Consumerì—ì„œ presence ê´€ë¦¬
async def connect(self):
    await self.channel_layer.group_send(
        self.room_group_name,
        {
            'type': 'user_join',
            'username': self.scope['user'].username
        }
    )

async def disconnect(self, close_code):
    await self.channel_layer.group_send(
        self.room_group_name,
        {
            'type': 'user_leave',
            'username': self.scope['user'].username
        }
    )
```

### 3. ë©”ì‹œì§€ ì½ìŒ í™•ì¸
```typescript
// ë©”ì‹œì§€ ì½ìŒ ì²˜ë¦¬
const markAsRead = (messageId: string) => {
  wsService.current.send({
    type: 'read_receipt',
    messageId
  });
};
```

## ğŸ“Š ì„±ëŠ¥ ìµœì í™”

### 1. ë©”ì‹œì§€ í˜ì´ì§€ë„¤ì´ì…˜
```typescript
// ë¬´í•œ ìŠ¤í¬ë¡¤ë¡œ ì´ì „ ë©”ì‹œì§€ ë¡œë“œ
const loadMoreMessages = async () => {
  const olderMessages = await api.get(
    `/messages?before=${oldestMessageId}&limit=20`
  );
  setMessages(prev => [...olderMessages, ...prev]);
};
```

### 2. ë””ë°”ìš´ì‹±
```typescript
// íƒ€ì´í•‘ ì´ë²¤íŠ¸ ë””ë°”ìš´ì‹±
const debouncedTyping = useMemo(
  () => debounce(handleTyping, 500),
  []
);
```

### 3. ì—°ê²° ìƒíƒœ ê´€ë¦¬
```typescript
// ì¬ì—°ê²° ë¡œì§
const reconnectWithBackoff = (attempt = 1) => {
  const delay = Math.min(1000 * Math.pow(2, attempt), 30000);
  
  setTimeout(() => {
    wsService.connect()
      .catch(() => reconnectWithBackoff(attempt + 1));
  }, delay);
};
```

## ğŸ“š í•™ìŠµ ìë£Œ

### WebSocket
- [MDN - WebSocket API](https://developer.mozilla.org/ko/docs/Web/API/WebSocket)
- [WebSocket í”„ë¡œí† ì½œ ì´í•´í•˜ê¸°](https://tecoble.techcourse.co.kr/post/2021-09-05-web-socket/)

### Django Channels
- [Django Channels ê³µì‹ ë¬¸ì„œ](https://channels.readthedocs.io/)
- [Django Channels íŠœí† ë¦¬ì–¼](https://realpython.com/getting-started-with-django-channels/)

### ì‹¤ì‹œê°„ í†µì‹ 
- [Socket.IO vs WebSocket](https://www.educative.io/answers/socketio-vs-websocket)
- [ì‹¤ì‹œê°„ ì›¹ ê¸°ìˆ  ê°€ì´ë“œ](https://www.html5rocks.com/ko/tutorials/websockets/basics/)

## ğŸ’¡ ì‹¤ìŠµ ì•„ì´ë””ì–´

1. **ì±„íŒ… ê¸°ëŠ¥ í™•ì¥**
   - ì´ë¯¸ì§€/íŒŒì¼ ì „ì†¡
   - ìŒì„± ë©”ì‹œì§€
   - ì´ëª¨ì§€ ë°˜ì‘

2. **ì‹¤ì‹œê°„ ê¸°ëŠ¥ ì¶”ê°€**
   - ì˜¨ë¼ì¸ ì‚¬ìš©ì ëª©ë¡
   - íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„°
   - ì½ìŒ í™•ì¸

3. **ì„±ëŠ¥ ê°œì„ **
   - ë©”ì‹œì§€ ìºì‹±
   - ê°€ìƒ ìŠ¤í¬ë¡¤ë§
   - ì••ì¶• ì ìš©

## ğŸ¤” ìƒê°í•´ë³¼ ë¬¸ì œ

1. WebSocket vs Server-Sent Eventsì˜ ì°¨ì´ëŠ”?
2. ëŒ€ê·œëª¨ ì±„íŒ… ì„œë¹„ìŠ¤ëŠ” ì–´ë–»ê²Œ í™•ì¥í• ê¹Œ?
3. ì‹¤ì‹œê°„ í†µì‹ ì˜ ë³´ì•ˆ ì´ìŠˆëŠ”?

---

ë‹¤ìŒ ë¬¸ì„œ: [06-AI-ëª¨ë¸-í†µí•©.md](./06-AI-ëª¨ë¸-í†µí•©.md) ì—ì„œ AI ëª¨ë¸ í†µí•© ë°©ë²•ì„ ì•Œì•„ë´ìš”!